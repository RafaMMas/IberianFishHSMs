---
output: github_document

bibliography: references.bib
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# IberianFishHSMs 

<!-- badges: start -->

`r lifecycle::badge("experimental")`

<!-- badges: end -->

IberianFishHSMs: Compilation of models and tools to evaluate the habitat suitability at the microhabitat scale for Iberian freshwater fish species. The modelling approaches include sets of Habitat Suitability Curves (HSCs), Artificial Neural Networks (Multilayer Perceptrons, ANN-MLPs), Random Forests (RFs), Generalised Additive Models (GAMs), and Support Vector Machines (SVMs), all based on empirical data collected across several river basins in the Iberian Peninsula. The HSCs have been reviewed by an expert panel, which coauthored the package. The package also compiles sets of HSCs and Fuzzy Rule-Based Systems (FRBSs) based on expert knowledge, which was gathered through online forms. Functions for evaluating habitat suitability from hydraulic simulations and for plotting the modelled suitability are also included. An thorough example of the capabilitites of the packages appears below. The package includes 797 habitat suitability models for 43 species and up to 4 size classes (Large, Medium, Small, Very small) and spawning (for *Salmo trutta* and *Salmo salar*).

<br/>

## Authors

This package was developed by:

- **Rafael Muñoz-Mas** (Author, Creator and Maintainer) - rafa.m.mas@gmail.com
- **Carlos Alonso** (Contributor)
- **Enric Aparicio Manau** (Contributor)
- **Fernando Cobo Gradín** (Contributor)
- **Gustavo González Fernández** (Contributor)
- **Javier Gortázar** (Contributor)
- **Francisco Martínez-Capel** (Contributor)
- **Francisco J. Oliva-Paterna** (Contributor)
- **Jose Prenda** (Contributor)
- **Jose Maria Santos** (Contributor)
- **Rafael Miranda Ferreiro** (Contributor)

<br/>

## Installation

IberianFishHSMs can be installed from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("RafaMMas/IberianFishHSMs")
```

<br/>

## Example

IberianFishHSMs includes examples that illustrate the package's capabilities and the general workflow for predicting habitat suitability using outputs from hydraulic simulations and field data. Fiel data includes the substrate and cover (shelter) distribution across the study site, by pattch, pixel or cell.

```{r load package, echo = TRUE}
library(IberianFishHSMs)
```

<br/>

### ListModels - List available models and their key characteristics.

`ListModels` allows inpecting the available models. The queries can be categorized by Species, Size, River, Model.type, Sampled.season, Valid.season, and/or Data.origin. This function also provides de Codes to internally call the habitat suitability models during the habitat evaluation. The output of this function also renders a summary of their main characteristics, including sample sizes, and serveal perfomrance criteria.   

```{r ListModels, echo = TRUE}
ListModels(Species = "Salmo trutta", verbose = F)
```

There exist an interaction between the training data and the modelling technique, which can vary variable effects and importance [@Eugster2014]. By means of cross-validation, during the development of the habitat suitbility models we carried out a variable selection approach discarding those cover types that not improved model performance. This approach lead to a different sets of relevant cover types in each model. The function `ListSelectedCoverTypes` allows inspecting the selcted cover types for each model. The queries can be categorized by Species, Size, River, Model.type, Sampled.season, Valid.season, and/or Data.origin. When evaluating the habitat suitability `PredictHabitatSuitability` selects and aggregates the appropriate cover types internally and this functions does not need to be called.

```{r ListSelectedCoverTypes, echo = TRUE}

ListSelectedCoverTypes(Species = "Salmo trutta")

```

<br/>

### Sensitivity analysis

The package includes a number of models (i.e., 797) and species (i.e., 43) several size classes and activities. Among other things, the available models vary by modelling technique, sampling site and the aggregation of data from different sites. The variable `Default` indicates which models are recommended becuase it was considered they generalised better but users can select other models when they consider it adequate. For example, when they are going to evalaute the habitat suitability in the basin where data for an alternative models was colected. In adiition to `ListSelectedCoverTypes`, users can carry out sensitivity analyses to compare the predictions of the different alternatives before selecting any particular set of models. The sensitivity analysis can be carried out employing function `Plot Habitat Suitability Models` as follows:

```{r, fig.width = 8, fig.height = 5, dpi=800}

## Pseudochondrostoma.polylepis, large, FRBS for Spring, Summer, and Autumn

(Selected.model <- ListModels(Species = "Pseudochondrostoma polylepis", verbose = FALSE)$Codes[1])

PlotHabitatSuitabilityModels(Selected.model = Selected.model, Quantiles = TRUE)

```

**Figure 1** - Sensitivity analysis (i.e., partial dependence plots) for *Pseudochondrostoma polylepis* large. The figure shows the results for for the Fuzzy Rule-Based System to evaluate the microhabitat suitability during Spring, Summer, and Autumn.

<br/>

### Habitat suitability prediction

Habitat suitability predictions are carried out based on mean flow velocity (m/s), water depth (m) substrate index (-) and the sum of the number of relevant types of cover in the evaluate microhabitats (i.e. pixels or cells from the hydraulic simulation). The package includes functions to prepare the input data.

``` {r Habitat assessment}
data("Velocity.example.df")
data("Depth.example.df")
data("Substrate.index.example.df")
data("Cover.example.df")

summary(Velocity.example.df)
summary(Depth.example.df)
summary(Substrate.index.example.df)
summary(Cover.example.df)

```

The function `SubstrateIndex` computes the substrate index as a weighted aggregation of the percentage of different granulometry classes (%). The substrate classes originally used corresponded to a simplification of the the American Geophysical Union size scale, namely silt (Ø ≤ 62 µm), sand (62 µm > Ø ≤ 2 mm), fine gravel (2 > Ø ≤ 8 mm), gravel (8 > Ø ≤ 64 mm), cobbles (64 > Ø ≤ 256 mm), boulders (Ø > 256 mm) and bedrock [see e.g., @Munoz-Mas2018 or @Munoz-Mas2017]. The package includes som examples to ilustrate the structure of the input files.

```{r SubstrateIndex, echo = TRUE}
data(Substrate.index.example.df)

summary(Substrate.index.example.df)

head(SubstrateIndex(Substrate.index.example.df, check.completeness = FALSE)) # check.completeness allows inspecting whether names and percentages are correct.

Substrate.index <- SubstrateIndex(Substrate.index.example.df, check.completeness = FALSE)

```

```{r select model for evaluation}

Selected.species <- "Cobitis paludica"

Selected.size <- "Large"
  
(Selected.models <- ListModels(Species = Selected.species, Size = Selected.size)) ## example determining the selected models 
```

```{r}
Hydraulics <- data.frame(Velocity = Velocity.example.df$Velocity.0.05,
                         Depth = Depth.example.df$Depth.0.05,
                         Substrate.index = Substrate.index,
                         Cover.example.df[,-c(1:2)])

Predictions <- PredictHabitatSuitability(Selected.models = Selected.models, data = Hydraulics, HSC.aggregation = "geometric")

```

```{r plot anc compare predicted microhabitat suitability}

pairs(Predictions)

Predictions

library(sf)

Coordinates <- st_as_sf(Velocity.example.df[,c("x", "y")], coords = c("x", "y"))

Colors.suitability <- colorRampPalette(c("red2", "darkorange", "gold", "green2", "dodgerblue"))(100)

# sf_points <- st_as_sf(data.frame(Example.hydrulic.simulation.depth[,c("x", "y")], Predictions), coords = c("x", "y"), crs = 32630)

Model.names <- sapply(colnames(Predictions), function(x){
  x <- gsub(x = x, pattern = paste0(gsub(Selected.species, pattern = " ", replacement = "."), "."), replacement = "")
  x <- gsub(x = x, pattern = paste0(Selected.size, "."), replacement = "")
  x
})

op <- par(mfrow = c(ceiling(length(Selected.models$Models)^0.5), ceiling(length(Selected.models$Models)^0.5)), oma = c(0.5,0.5,2.5,0.5), mar = c(4,4,2,0.5))

for(i in 1:ncol(Predictions))
{
  plot(st_geometry(Coordinates), pch = 15, cex = 0.5, bty = "n", 
     col = Colors.suitability[cut(Predictions[,i], breaks = seq(0, 1, length = 101), labels = 1:100, include.lowest = T)], 
     xlab = "X", ylab = "Y")
  Axis(side = 1, cex.axis = 0.5)
  Axis(side = 2, cex.axis = 0.5) 
  title(Model.names[i], font.main = 1, cex.main = 0.9)
}

par(op)

Species <- Selected.species
Size <- paste0(" - ", Selected.size)
title(substitute(expr = paste(italic(Species), Size, sep =" "), env = list(Species = Species, Size = Size)), outer = T, adj = 0.05, cex.main = 2)

par(op)

```

<br/>

## Bibliography
