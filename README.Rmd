---
output: github_document

bibliography: references.bib
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

<br/>

```{r, eval = F, echo = F, fig.align='right'}
## Açò afegeix el badge
<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
<!-- badges: end -->

<div style="float: right; vertical-align: top">
  <img src="man/figures/logo.png" alt="Banner" style="max-height: 40px;"/>
</div> 
  
```

<div style="text-align: left;">
  <img src="man/figures/logo_tragsatec_SEPI_MITECO.png" alt="Banner" style="max-height: 75px;"/>
</div>

<div style="clear: both;"></div>

<br/>

<br/>

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
<!-- badges: end -->

# IberianFishHSMs 

<div style="text-align: justify;">
IberianFishHSMs: Compilation of models and tools to evaluate the habitat suitability at the microhabitat scale for Iberian freshwater fish species. The modelling approaches include sets of Habitat Suitability Curves (HSCs) [@Waters1976], Artificial Neural Networks (Multilayer Perceptron ensembles, ANN-MLPs) [@Hansen1990], Random Forests (RFs)[@Breiman2001], Generalised Additive Models (GAMs) [@Hastie1990], and Support Vector Machines (SVMs) [@Vapnik1995; @Cortes1995], all based on empirical data collected across several river basins of the Iberian Peninsula. The HSCs have been reviewed by an expert panel, who co-authored the package. The package also compiles additional sets of HSCs and Fuzzy Rule-Based Systems (FRBSs) [@Zadeh1965; @Takagi1985] developed from literature and expert knowledge, which was gathered through on-line forms. Functions for evaluating the habitat suitability from hydraulic simulations and for plotting the modelled microhabitat preferences and suitability are also included. A thorough example of the capabilities of the packages appears in this manual. The package includes 797 microhabitat suitability models for 43 species and up to 4 size classes (Large, Medium, Small, Very small) and spawning/nesting suitability (only for *Salmo trutta* and *Salmo salar*). To develop the microhabitat suitability models we harnessed the functions and capabilities of the following packages:
</div>

- Habitat Suitability Curves (HSCs): `FuzzyFishHS` [github link](https://github.com/RafaMMas/FuzzyFishHS)
- Artificial Neural Networks (Multilayer Perceptron ensembles, ANN-MLPs): `nnet` [CRAN link](https://cran.r-project.org/web/packages/nnet/index.html)
- Random Forests (RFs): `ranger` [CRAN link](https://cran.r-project.org/web/packages/ranger/index.html)
- Generalised Additive Models (GAMs): `mgcv` [CRAN link](https://cran.r-project.org/web/packages/mgcv/index.html)
- Support Vector Machines (SVMs): `e1071` [CRAN link](https://cran.r-project.org/web/packages/e1071/index.html)
- Fuzzy Rule-Based Systems (FRBSs): `FuzzyFishHS` [github link](https://github.com/RafaMMas/FuzzyFishHS)

<br/>

## Authors

This package was developed by:

- **Rafael Muñoz-Mas**<sup>1</sup> (Author, Creator and Maintainer) - rafa.m.mas@gmail.com
- **Carlos Alonso**<sup>2</sup> (Contributor)
- **Enric Aparicio Manau**<sup>3</sup> (Contributor)
- **Fernando Cobo Gradín**<sup>4</sup> (Contributor)
- **Gustavo González Fernández**<sup>5</sup> (Contributor)
- **Javier Gortázar**<sup>6</sup> (Contributor)
- **Francisco Martínez-Capel**<sup>7</sup> (Contributor)
- **Francisco J. Oliva-Paterna**<sup>8</sup> (Contributor)
- **Jose Prenda**<sup>9</sup> (Contributor)
- **Jose Maria Santos**<sup>10</sup> (Contributor)
- **Rafael Miranda Ferreiro**<sup>11</sup> (Contributor)

<div style="text-align: justify;">
<sup>1</sup> Tragsatec, Carrer Ramon Gordillo 7 - 46010 València, Spain.
<sup>2</sup>
<sup>3</sup> GRECO, Institute of Aquatic Ecology, University of Girona, E-17071 Girona.
<sup>4</sup> Laboratorio de Hidrobiologia, Departamento de Zoología, Genetica y Antropología Física. Facultad de Biología. Universidad de Santiago de Compostela, 15782 Santiago de Compostela, Spain.
<sup>5</sup> Icthios Gestión Ambiental SL. info@icthios.es.
<sup>6</sup> ECOHIDRÁULICA, S.L. C/ Villamanín 16, Madrid 28011.
<sup>7</sup> Institut d'Investigació per a la Gestió Integrada de Zones Costaneres (IGIC), Universitat Politècnica de València, C/Paranimf, 1, 46730 Gandia, València, Spain.
<sup>8</sup> Departamento de Zoología y Antropología Física. 30100. Universidad de Murcia. Murcia.
<sup>9</sup> Dpto. de Ciencias Integradas. Universidad de Huelva.
<sup>10</sup> Forest Research Centre, Associate Laboratory TERRA, School of Agriculture, University of Lisbon.
<sup>11</sup> Universidad de Navarra, Instituto de Biodiversidad y Medioambiente (BIOMA), 31008 Pamplona, Navarra, Spain.
</div>

<br/>

## Funding

<div style="text-align: justify;">
`IberianFishHSMs` was funded and commissioned to TRAGSATEC - SEPI by the Ministry for the Ecological Transition and the Demographic Challenge (MITECO) (Spanish Government). The data collection and development of the package were carried out as part of the project titled *Actualización y/o creación de curvas de idoneidad del hábitat físico para diversas especies acuáticas y ribereñas*, which was conducted under the framework of the *Servicio técnico para el desarrollo de modelos numéricos integrados e impulso a la restauración fluvial en las distintas demarcaciones hidrográficas intercomunitarias* (21.804-0047/0411).
</div>

```{r, eval = F, echo = F, fig.align='right'}
knitr::include_graphics("./man/figures/logo.png")
```

<br/>

## Installation

IberianFishHSMs can be installed from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("RafaMMas/IberianFishHSMs")
```

<br/>

## Example
<div style="text-align: justify;">
The following example illustrates the capabilities of IberianFishHSMs and the general workflow for predicting microhabitat suitability using outputs from hydraulic simulations and field data. Field data includes the substrate and cover (shelter) distribution across the study site, by patch, pixel or cell. The data used in this example is available from the package and has been adapted from he data published in Muñoz-Mas et al. [-@Munoz-Mas2024].
</div>

```{r load package, echo = TRUE}
library(IberianFishHSMs)
```

<br/>

### ListModels - List available models and their key characteristics

<div style="text-align: justify;">
`ListModels` allows inspecting the available models. The queries can be categorized by *Species*, *Size*, *River*, *Model.type*, *Sampled.season*, *Valid.season*, and/or *Data.origin*. This function also provides de *Codes* to internally call the microhabitat suitability models during the habitat evaluation to obtain the suitability associated to each microhabitat (i.e., patch, pixel or cell). The output of this function also renders a summary of their main characteristics, including sample sizes, and several performance criteria for those models optimised through cross-validation. The argument *Default* = *TRUE* renders those models recommended by the expert panel who co-authored the package. These models are, consequently, the best option among the available models, but the additional models have been included to allow site-specific studies. The following example shows the default output for brown trout (*Salmo trutta*). From columns #1 to #15 the general general characteristics are described. Columns #16 to #23 include the aforementioned performance indices. The output of this function is a three-elements list. The last two elements are names and codes. Names summarises the characteristics of each model in the table and, as indicated above, codes are used to internally call the odels compiled in the package.
</div>

```{r ListModels, echo = TRUE}
Selected.models <- ListModels(Species = "Salmo trutta", verbose = F)

## General characteristics
Selected.models$Current.summary.table[,1:15]

## Performance

Selected.models$Current.summary.table[,16:23]

## Models and Codes

Selected.models[2:3]

```

<div style="text-align: justify;">
`ListModels` output values can be use directly within `PredictHabitatSuitability` to carry out habitat evaluations. In particular, `$Codes` are the names used to store and call internally the available microhabitat suitability models.  
</div>

<br/>

### ListSelectedCoverTypes - List selected cover types in each microhabitat suitability model

<div style="text-align: justify;">
There exist an interaction between training data and the selected modelling technique, which can vary the effect of the predictor variables and/or their importance [@Eugster2014]. By means of cross-validation, during the development of the microhabitat suitability models, we carried out a variable selection approach discarding those cover types that not improved model performance for Machine Learning (i.e., ANN-MLPs, RFs, SVMs) and statistical approaches (i.e., GAMs) and an analogous approach was followed during the development of the Habitat Suitability Curves/Criteria (HSCs) and Fuzzy Rule-based Systems (FRBSs).  This approach lead to different sets of relevant cover types in each model, although the core of relevant cover types is expected to coincide. The function `ListSelectedCoverTypes` allows inspecting the selected cover types for each model. This will allow practitioner to discards some models when they are deemed inadequate. Likewise, the queries can be categorized by *Species*, *Size*, *River*, *Model.type*, *Sampled.season*, *Valid.season*, and/or *Data.origin*. When evaluating the microhabitat suitability, `PredictHabitatSuitability` selects and aggregates the appropriate cover types internally. Therefore, this function does not need to be called explicitly.
</div>

```{r ListSelectedCoverTypes, echo = TRUE}

ListSelectedCoverTypes(Species = "Salmo trutta")

```

<br/>

### PlotHabitatSuitabilityModels - Carry out sensitivity analyses

<div style="text-align: justify;">
The package includes a number of models (i.e., 797) and species (i.e., 43) of several size classes and activities. Among other things, the available models vary by modelling technique, sampling site and the aggregation of data from different sites and rivers. The variable `Default` obtained with `ListModels` indicates which models are recommended because it was considered they performed and generalised better and/or were developed with data covering a large range of the microhabitat variables. Nevertheless, users can select other models when they consider it preferable. For example, when they are going to evaluate the microhabitat suitability in the basin where data for an alternative model were collected. In addition to `ListSelectedCoverTypes`, users can carry out sensitivity analyses to compare the predictions of the different available models and select the one that better adjust to their interests and specific knowledge. This allows inspecting their performance before selecting any alternative model or set of models. The sensitivity analysis can be carried out employing the function `PlotHabitatSuitabilityModels` as follows:
</div>

```{r, fig.width = 8, fig.height = 5, dpi=800}

## Pseudochondrostoma.polylepis, large, FRBS for Spring, Summer, and Autumn

(Selected.model <- ListModels(Species = "Pseudochondrostoma polylepis", verbose = FALSE)$Codes[1])

PlotHabitatSuitabilityModels(Selected.model = Selected.model, Quantiles = TRUE)

```

**Figure 1** - Sensitivity analysis (i.e., partial dependence-like plots) for *Pseudochondrostoma polylepis* large. The figure shows the results for the Fuzzy Rule-Based System (FRBS) to evaluate the microhabitat suitability during Spring, Summer, and Autumn. The different coloured lines depict the quantiles of the predictions along the range of the studied variable. 

<div style="text-align: justify;">
This function generates partial dependence-like plots for microhabitat suitability models based on the provided data and selected model [@Friedman2001]. Partial dependence plots are created by varying one variable over its range of values while averaging the model's predictions over all the other features. In this case, the quantiles of these predictions are plotted. This method isolates the effect of that single variable on the outcome and thus determining the overall effect. The function allows employing a user defined dataset to test specific combinations of variable values. The function allows plotting the mean effect by setting `Quantiles` to `FALSE`. 
</div>

<br/>

### LoadAndPrintModel - Load and/or print a specific model

`LoadAndPrintModel` allows selecting any specific model and assigning it to an *R* object, as well as printing this model.  

```{r Load.and.print.model}
(Selected.model <- ListModels(Species = "Salmo trutta", Model.type = "GAM", verbose = FALSE))

(Selected.model <- LoadAndPrintModel(Selected.model = Selected.model$Codes[1]))
```

<br/>

As indicated at the beginning of this manual, each group of models was developed employing specific *R* packages:

- Habitat Suitability Curves (HSCs): `FuzzyFishHS` [github link](https://github.com/RafaMMas/FuzzyFishHS)
- Artificial Neural Networks (Multilayer Perceptron ensembles, ANN-MLPs): `nnet` [CRAN link](https://cran.r-project.org/web/packages/nnet/index.html)
- Random Forests (RFs): `ranger` [CRAN link](https://cran.r-project.org/web/packages/ranger/index.html)
- Generalised Additive Models (GAMs): `mgcv` [CRAN link](https://cran.r-project.org/web/packages/mgcv/index.html)
- Support Vector Machines (SVMs): `e1071` [CRAN link](https://cran.r-project.org/web/packages/e1071/index.html)
- Fuzzy Rule-Based Systems (FRBSs): `FuzzyFishHS` [github link](https://github.com/RafaMMas/FuzzyFishHS)

<div style="text-align: justify;">
Therefore, once a specific model has been loaded, it is possible to harness the capabilities of each specific package to, for example, plot directly the selected model. The following code shows an example using the function `plot` from `mgcv` to visualise the effects of the smooth spline functions of a Generalised Additive Model (GAM) for brown trout (*Salmo trutta*) large obtained with data collected in the Curueño River (Douro) and valid all year round.  
</div>

```{r GAMplot, fig.width = 8, fig.height = 5, dpi=800}
library(mgcv)
par(mar = c(4,4,1,1), bty = "n")
plot.gam(Selected.model$Model, pages = 1, shade=TRUE, shade.col = "dodgerblue")
```
**Figure 2** - Plot of the Generalised Additive Model for *Salmo trutta* Large obtained with data collected in the Curueño River (Douro) and valid all year round.

<div style="text-align: justify;">
The different option to, for example, plot each models depend on each specific package and in some cases suchs the SVMs obtained with `e1071` require indirect approaches for plotting. For instance, using the *R* package `pdp` [@RJ-2017-016].
</div>

<br/>

### PredictHabitatSuitability - Habitat suitability predictions

<div style="text-align: justify;">
Habitat suitability predictions are carried out with `PredictHabitatSuitability` and are based on mean flow velocity (m/s), water depth (m) substrate index (-) and the sum of the number of relevant types of cover in the evaluated microhabitats (i.e., pixels or cells from the hydraulic simulation). The package includes functions to prepare the input data (i.e., `SubstrateIndex`). Additionally, the package includes data on a typical output from a hydraulic simulation and the data on substrate and cover distribution and availability from the field survey carried out in concert of the bathymetry. In particular, it includes data on velocity and depth for 40 simulated flows and the substrate composition and cover availability in the 400-m reach of the Serpis River (Eastern Iberian Peninsula) studied by Muñoz-Mas et all. [-@Munoz-Mas2024]. The data and subsequent analyses are intended to show the capabilities of the package and do not imply the species are present in this reach of the Serpis River or along its water course. For simplicity the data are stored in four separated files that can be loaded to the workspace using the function `data` as follows:
</div>

<br/>

``` {r Habitat assessment}
data("Velocity.example.df")
data("Depth.example.df")
data("Cover.example.df")
data("Substrate.index.example.df")

summary(Velocity.example.df[,1:6])
summary(Depth.example.df[,1:6])
summary(Cover.example.df[,-c(1:2)])
summary(Substrate.index.example.df[,-c(1:2)])

```

<br/>

In this reach of the Serpis River the water flows northward (upwards). The reach presents a series of small and relatively shallow pools connected throw rapid waters (i.e., rapid/runs). The bigger pool is located at the downstream part of the reach. 

<br/>

```{r depth and velocity figure, echo = FALSE, warning=FALSE, fig.width = 8, fig.height = 10, out.height = "100%", dpi=800}

library(sf)

Coordinates <- st_as_sf(Velocity.example.df[,c("x", "y")], coords = c("x", "y"))

Colors.velocity <- viridis::magma(100, direction = -1)
Colors.depth <- viridis::viridis(100, direction = -1)

Seq.velocity <- seq(0, max(Velocity.example.df[,-c(1:2)], na.rm = T), length = 101)
Seq.depth <- seq(0, max(Depth.example.df[,-c(1:2)], na.rm = T), length = 101)

op <- par(mfrow = c(2, 4),
          oma = c(0.25, 0.25, 4, 0.25),
          mar = c(4, 4, 1, 0.25))

for(i in c(8, 25, 30, 42))
{
  c.flow <- gsub(x = colnames(Velocity.example.df)[i], pattern = "Velocity.", replacement = "")
  plot(st_geometry(Coordinates), pch = 15, cex = 0.5, bty = "n", 
     col = Colors.velocity[cut(Velocity.example.df[,i], breaks = Seq.velocity, labels = 1:100, include.lowest = T)], 
     xlab = "X", ylab = "Y")
  Axis(side = 1, cex.axis = 0.5)
  Axis(side = 2, cex.axis = 0.5) 
  title(substitute(paste("Q: ", c.flow, " ", m^3/s),  env = list(c.flow = c.flow)), font.main = 1, line = -0.5, cex.main = 1, adj = 0.5)
  title(substitute(paste("max. vel. = ", max.vel, " m/s"), env = list(max.vel = round(max(Velocity.example.df[,i], na.rm = T), 1))), font.main = 1,
        line = -30, cex.main = 1, adj = 0.2)
}

for(i in c(8, 25, 30, 42))
{
  c.flow <- gsub(x = colnames(Velocity.example.df)[i], pattern = "Depth.", replacement = "")
  plot(st_geometry(Coordinates), pch = 15, cex = 0.5, bty = "n", 
     col = Colors.depth[cut(Depth.example.df[,i], breaks = Seq.depth, labels = 1:100, include.lowest = T)],
     xlab = "X", ylab = "Y")
  Axis(side = 1, cex.axis = 0.5)
  Axis(side = 2, cex.axis = 0.5) 
  title(substitute(paste("Q: ", c.flow, " ", m^3/s),  env = list(c.flow = c.flow)), font.main = 1, line = -0.5, cex.main = 1, adj = 0.5)
  title(substitute(paste("max. depth = ", max.vel, " m"), env = list(max.vel = round(max(Depth.example.df[,i], na.rm = T), 1))), font.main = 1,
        line = -30, cex.main = 1, adj = 0.2)
}

par(op)

title("Depth and velocity in the Serpis River reach (JRBD)", outer = T, line = -2, adj = 0.5, cex.main = 1)

par(op)

```

**Figure 3** - Velocity (m/s) and depth (m) distribution in the Serpis River (Jucar River Basin District) for four different modelled flow rates (m<sup>3</sup>/s). included in the `Velocity.example.df` and `Velocity.example.df` respectively. 

<div style="text-align: justify;">
Among the ten types used to develop the microhabitat suitability models, in this river reach leaves, algae, roots, and sand were absent. The most abundant cover types were logs and woody debris (wood) and shade which covered most of the margins. Rock was the most abundant instream cover, especially in the transition zone between pools, whereas the remaining cover types were only present in small patches.
</div>

<br/>

``` {r plot cover, echo = FALSE, warning=FALSE, fig.width = 9, fig.height = 10, out.height = "100%", dpi=800}

library(sf)

Coordinates <- st_as_sf(Velocity.example.df[,c("x", "y")], coords = c("x", "y"))

Colors.cover <- c("grey", "forestgreen")

op <- par(mfrow = c(2, 5),
          oma = c(0.25, 0.25, 4, 0.25),
          mar = c(4, 4, 2.5, 0.25))

for(i in 1:ncol(Cover.example.df[,-c(1:2)]))
{
  plot(st_geometry(Coordinates), pch = 15, cex = 0.5, bty = "n", 
     col = Colors.cover[Cover.example.df[,-c(1:2)][,i]+1], 
     xlab = "X", ylab = "Y")
  Axis(side = 1, cex.axis = 0.5)
  Axis(side = 2, cex.axis = 0.5) 
  title(colnames(Cover.example.df[,-c(1:2)])[i], font.main = 1, line = -0.5, cex.main = 1, adj = 0.7)
}

par(op)

title("Available cover in the Serpis River reach (JRBD)", outer = T, line = -3, adj = 0.5, cex.main = 1)

par(op)

```

**Figure 4** - Distribution of each cover type along the reach of the Serpis River (Jucar River Basin District). The models were developed considering ten types of cover (refuge/shelter): Leaves, Algae, Roots, Aquatic vegetation, Reeds (emerging vegetation), Woody debris and logs, Sand, Rocks, Caves, and Shade, which are included (but no necessarily present) in the `Cover.example.df`.  

<br/>

<div style="text-align: justify;">
The function `SubstrateIndex` computes the substrate index as a weighted aggregation of the percentage of different granulometry classes (%). The substrate classes originally used corresponded to a simplification of the the American Geophysical Union size scale, namely silt (Ø ≤ 62 µm), sand (62 µm > Ø ≤ 2 mm), fine gravel (2 > Ø ≤ 8 mm), gravel (8 > Ø ≤ 64 mm), cobbles (64 > Ø ≤ 256 mm), boulders (Ø > 256 mm) and bedrock [see e.g., @Munoz-Mas2018 or @Munoz-Mas2017]. The package includes some examples to illustrate the structure of the input files.
</div>

```{r SubstrateIndex, echo = TRUE}
data(Substrate.index.example.df)

summary(Substrate.index.example.df)

head(SubstrateIndex(Substrate.index.example.df, check.completeness = FALSE)) # check.completeness allows inspecting whether names and percentages are correct.

Substrate.index <- SubstrateIndex(Substrate.index.example.df, check.completeness = FALSE)

```

<br/>

<div style="text-align: justify;">
The substrate index ranges from 0 fines/silt to 8 bedrock. In the example site in the Serpis River

</div>
<br/>

```{r substrate index map, echo = FALSE, eval = TRUE, fig.width = 8, fig.height = 5, out.height = "110%", dpi=800}

library(sf)

Coordinates <- st_as_sf(Velocity.example.df[,c("x", "y")], coords = c("x", "y"))

Colors.substrate.index <- viridis::turbo(100)

op <- par(mfrow = c(1, 4),
          oma = c(0.25, 0.25, 4, 0.25))

op1 <- par(mar = c(4, 4, 1, 0.25))

plot.new()

plot(st_geometry(Coordinates), pch = 15, cex = 0.5, bty = "n", 
col = Colors.substrate.index[cut(Substrate.index$Substrate.index, seq(0, 8, length = 101), labels = 1:100, include.lowest = FALSE)],      xlab = "X", ylab = "Y")
Axis(side = 1, cex.axis = 0.5)
Axis(side = 2, cex.axis = 0.5) 

par(op1)

op1 <- par(mar = c(4, 3, 9, 11))

plot(rep(0, 100), seq(0, 8, length = 100), pch = 15, cex = 2.5, col = Colors.substrate.index, ann = F, bty = "n", axes = FALSE, xaxs = "i", yaxs = "i")
Axis(side = 4, las = 1)
mtext(side = 4, "Substrate index (-)", las = 0, line = 2.75)

plot.new()

par(op)

title("Substrate index in the Serpis River reach (JRBD)", outer = T, line = -3, adj = 0.5, cex.main = 1)

par(op)

```

**Figure 5** - Substrate composition (substrate index) along the reach of the Serpis River (Jucar River Basin District). The percentages (%) of the different substrate types are stored in `Cover.example.df`.

```{r select model for evaluation}

Selected.species <- "Cobitis paludica"

Selected.size <- "Large"
  
(Selected.models <- ListModels(Species = Selected.species, Size = Selected.size)) ## example determining the selected models 
```

```{r}
Hydraulics <- data.frame(Velocity = Velocity.example.df$Velocity.0.5,
                         Depth = Depth.example.df$Depth.0.5,
                         Substrate.index = Substrate.index,
                         Cover.example.df[,-c(1:2)])

Predictions <- PredictHabitatSuitability(Selected.models = Selected.models, data = Hydraulics, HSC.aggregation = "geometric")

```

```{r}

summary(Predictions)

```

```{r pairplot names, echo = FALSE}

colnames(Predictions) <- gsub(x = gsub(x = colnames(Predictions), pattern = "Cobitis.paludica.", replacement = ""), pattern = "Large.", replacement = "")
colnames(Predictions) <- gsub(x = colnames(Predictions), pattern = "\\.", replacement = "\n")

Species <- Selected.species
Size <- paste0(" - ", Selected.size)

```

```{r pairplot, fig.width = 5, out.width = "100%", fig.height = 5.5, dpi=800}

pairs(Predictions, col = "red4", oma = c(2.5, 2.5, 7, 2.5), cex.labels = 0.75, lwd = 0.5, cex = 0.75, cex.axis = 0.85)

title(substitute(expr = paste(italic(Species), Size, sep =" "), env = list(Species = Species, Size = Size)), outer = T, line = -3, adj = 0.5, cex.main = 1.5)

```

<br/>

```{r maps names, echo = FALSE}

colnames(Predictions) <- gsub(x = colnames(Predictions), pattern = "\n", replacement = " ")

```

<br/>

<div style="text-align: justify;">
The coordinates included in the data included in `IberianFishHSMs` allows plotting the microhabitat suitability predicted with each selected model employing functions from `sf`. First, it is necessary to create a point object with the coordinates and the desired colour sequence. In this case ranging from \textcolor{red}{red} to \textcolor{blue}{blue}. Then, a loop iterativelly plotting thedifferent maps is carried out and the figure tile is added. 
</div>

<br/>

```{r compareplot code, eval = FALSE, fig.width = 8, fig.height = 10, out.height = "110%", dpi=800}

library(sf)

Coordinates <- st_as_sf(Velocity.example.df[,c("x", "y")], coords = c("x", "y"))

Colors.suitability <- colorRampPalette(c("red2", "darkorange", "gold", "green2", "dodgerblue"))(100)

op <- par(mfrow = c(2, 4),
          oma = c(0.25, 0.25, 4, 0.25),
          mar = c(4, 4, 1, 0.25))

for(i in 1:ncol(Predictions))
{
  plot(st_geometry(Coordinates), pch = 15, cex = 0.5, bty = "n", 
     col = Colors.suitability[cut(Predictions[,i], breaks = seq(0, 1, length = 101), labels = 1:100, include.lowest = T)], 
     xlab = "X", ylab = "Y")
  Axis(side = 1, cex.axis = 0.5)
  Axis(side = 2, cex.axis = 0.5) 
  title(colnames(Predictions)[i], font.main = 1, line = -0.5, cex.main = 1, adj = 0.7)
}

par(op)

Species <- Selected.species
Size <- paste0(" - ", Selected.size)
title(substitute(expr = paste(italic(Species), Size, sep =" "), env = list(Species = Species, Size = Size)), outer = T, line = -1, adj = 0.5, cex.main = 2)

par(op)

```

<br/>

<div style="text-align: justify;">
The different models assign the highest suitability to the downstream pool (upper part of the map). However, the maps developed employing the preceding code reveal the differences among the microhabitat suitability models. The Fuzzy Rule-Based Systems (FRBSs) assign large suitability to the deeper areas and the shores of the pools comprised within the hydraulic model. Both of them predicted as unsuitable the rapids connecting them but the FRBSs for Winter is more restrictive than the one for Summer and predicts as suitable only the deeper parts of these pools. The Generalised Additive Model (GAM) and the Habitat Suitability Curves (HSCs) predicted high suitability in the deeper part of the upstream pool and particularly to the shores, but the upstream smaller pools were unsuitable with the GAM and largely suitable with the HSCs. The latter highlights the compensatory nature of the geometric mean used to aggregate the suitability obtained from each independent microhabitat suitability curve. The Artificial Neural Network (NNET) only considered suitable a fringe along the right margin and some specific spots in the opposite margin. The Random forest model (RF) only predicted as suitable the deeper parts and, based on this model predictions, both margins were evaluated as unsuitable. The predictions of the Support Vector Machine (SVM) were similar but, this technique evalauted the deeper parts of the pool with the highest suitability (i.e., 1). These models are base
</div>

<br/>

```{r compareplot figure, echo = FALSE, warning=FALSE, fig.width = 8, fig.height = 10, out.height = "100%", dpi=800}

library(sf)

Coordinates <- st_as_sf(Velocity.example.df[,c("x", "y")], coords = c("x", "y"))

Colors.suitability <- colorRampPalette(c("red2", "darkorange", "gold", "green2", "dodgerblue"))(100)

op <- par(mfrow = c(2, 4),
          oma = c(0.25, 0.25, 4, 0.25),
          mar = c(4, 4, 1, 0.25))

for(i in 1:ncol(Predictions))
{
  plot(st_geometry(Coordinates), pch = 15, cex = 0.5, bty = "n", 
     col = Colors.suitability[cut(Predictions[,i], breaks = seq(0, 1, length = 101), labels = 1:100, include.lowest = T)], 
     xlab = "X", ylab = "Y")
  Axis(side = 1, cex.axis = 0.5)
  Axis(side = 2, cex.axis = 0.5) 
  title(colnames(Predictions)[i], font.main = 1, line = -0.5, cex.main = 1, adj = 0.7)
}

par(op)

Species <- Selected.species
Size <- paste0(" - ", Selected.size)
title(substitute(expr = paste(italic(Species), Size, sep =" "), env = list(Species = Species, Size = Size)), outer = T, line = -1, adj = 0.5, cex.main = 2)

par(op)

```

**Figure 6** - Maps depicting the predicted microhabitat suitability for *Cobitis paludica* small in a reach of the Serpis River (Jucar River Basin District - JRBD). The maps show the predictions for 0.5 m<sup>3</sup>/s. The figure depicts the predictions from seven different models. The Fuzzy Rule-Based Systems (FRBSs) were obtained from expert-knowledge and literature (EKorL) and they are valid for Summer (warm period) and Winter (cold period) respectively. The figure also depicts the predictions carried out with the Generalised Additive Model (GAM), Habitat Suitability Curves (HSCs), Artificial Neural Network (NNET), Random forests (RF) and Support Vector Machine (SVM). All these models were developed pooling data from the Estena (Guadiana) and Yeguas (Guadalquivir) rivers. Currently, these models are valid for every season (*All*).

<br/>

## Bibliography
